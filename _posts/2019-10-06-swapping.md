---
title: 6. 请求式分页和虚存交换功能（实验）
---

XV6 是运行在 X86 框架上的，理论上可以实现虚存功能，但 XV6 没有，现在我们给 XV6 添加虚存功能。

由于盘块和物理页帧大小不一，申请内存这部分代码也要做相应的修改，我们设计为请求式分页功能。

我们知道文件系统的盘块大小为 512 字节，而内存页帧大小为 4096 字节。若要实现虚存功能，那么一个页帧需要 8 个盘块存储，为了尽量复用 XV6 的代码，我们的文件读写以 8 个盘块对齐，这样就可以存储整个物理页帧了。

## 1. 交换功能

当页帧不够的时候，我们需要将不在 run 状态的进程中的页帧放到文件系统，从而腾出空闲的物理页帧。

XV6 的磁盘读写必须经过日志层和缓存层，我们将 4096 大小的页帧写到 8 块连续的 512 大小的盘块中，并在页表项记录开始盘块的盘块号。先在 `bio.c` 中进行相应的修改。这里由于 XV6 默认的文件系统设备号只有 1 个，`dev=1`，所以我们直接使用 1 作为 `dev` 参数。

```c
// 将 4096 字节的物理页帧写到 blockno 为起始的连续的 8 块盘块中
void swapout(char *pa, uint blockno) 
```

若某运行中的进程发现自己的页帧此时在文件系统上，那么需要中断等待，知道文件系统上的内容重新加载到相应的物理页帧中。

从连续的 8 块盘块中读取内容到 1 块物理页帧中。

```c
void swapin(char *pa, uint blockno)
```

## 2. 分配盘块

和文件的分配盘块函数 `balloc` 类似，除了要分配连续的 8 块盘块以外，如果盘块是以 8 块对齐的就没问题。

```c
uint balloc_page(uint dev)
```

释放使用 `balloc_page` 分配的盘块。

```c
void bfree_page(int dev, uint b)
```

为了适配以 8 对齐的要求，要稍微修改 `bfree()` 函数。

## 3. 测试程序

### 3.1 测试页请求

分配页的时候，我们一开始并没有真正把页分配给进程，只是将页表的相应位进行设置而已。如果进程要访问该页，则会触发请求，然后

1. 如果有空闲物理内存，则直接从 `kmem` 中获取内存。
2. 如果没有空闲物理内存，则将某些进程的页换出磁盘，腾出物理页帧来使用。

## 