---
title: 1. 时间片修改实验
date: 2019-08-01
---

调度方面的我们安排两个实验：一个是热身性质的，只是将时间片延长到多个时钟中断，所需修改的代码比较少，也不涉及添加系统调用；另一个是优先级调度实验，由于涉及系统调用以及用于验证的用户可执行程序，因此略微复杂一点。 调度对操作系统而言很关键，但是代码量并不大。相对于内存管理、文件系统系统而言， 调度代码是相对简单的。

本节只讲时间片长度调整。我们来尝试将一个进程运行的时间片扩展为 N 个时钟周期。具体思路也很简单，为每个进程的 PCB 中添加时钟计数值，调度时当前进程的时间片未用完则不切换。

## 1. 增加时间片信息

在 `xv6` 的进程控制块 `proc.h` 中修改 `proc` 结构体，增加成员 `slot` 并定义时间片长度为 8 个 `tick`。 

然后在创建进程时分配 `proc` 结构体的 `allocproc()` 函数中设置新进程的 `slot` 成员，并设置为 `SLOT`。

为了能查看到进程时间片信息，还需要在 `proc.c` 中的 `procdump()` 函数中将输出信息增加一项时间片剩余量。

## 2. 时间片控制

`xv6` 原来的是实现在每次时钟中断时就调用 `yield()` 让出 CPU 并引发一次调度。现在修改后的代码需要对时间片剩余量进行递减，以及判定当前进程时间片是否用完，决定是否需要进行调度。修改后的代码在 `trap.c` 的 `trap()` 函数中完成上述检查。

 