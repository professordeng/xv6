---
title: 8. mkfs 工具
---

该工具是运行于 Linux 环境中的，为 xv6 系统生成磁盘文件系统的影像。其输入是可运行于 xv6 的多个应用程序。实现代码在 [mkfs.c](https://github.com/professordeng/xv6-expansion/blob/master/mkfs.c)，其中 [mkfs.c#L20](https://github.com/professordeng/xv6-expansion/blob/master/mkfs.c#L20) 给出了 xv6 磁盘文件系统的布局。

xv6 有两个磁盘，分别是 `xv6.img`，和 `fs.img`，其中 `fs.img` 用于文件系统，而 `xv6.img` 用于装载引导程序和系统内核。

`xv6.img` 布局如下：

| boot block | kernel    |
| ---------- | --------- |
| 第 0 块    | 从 1 开始 |

在 `Makefile` 中，`fs.img` 的生成如下：

```makefile
fs.img: mkfs README.md $(UPROGS)
  ./mkfs fs.img README.md $(UPROGS)
```

也就是说，文件系统是由 `mkfs` 程序生成的，包括布局、数据载入。文件系统的布局如下：

| 名字 | 引导块 | 超级块 | 日志区 | 索引节点区   | 位图区  | 数据区       |
| ---- | ------ | ------ | ------ | ------------ | ------- | ------------ |
| 大小 | 1      | 1      | nlog   | ninodeblocks | nbitmap | FSSIZE-nmeta |

引导块占用第 0 号物理块，不属于文件系统管辖，如果系统中有多个文件系统，只有根文件系统才有引导程序放在引导块中，其余文件系统都不使用引导块。

超级块占用第 1 号物理块，是文件系统的控制块。超级块包括：文件系统的大小、空闲块数目、空闲块索引表、空闲 `i` 节点数目、空闲 `i` 节点索引表、封锁标记等。超级块是系统为文件分配存储空间、回收存储空间的依据。

在 xv6 中，引导块没有作用。

## 1. 超级块的初始化

超级块描述了文件系统的整体框架信息，所以 `mkfs.c` 首先设置超级块。主要是盘块的划分和不同区域的起点等信息。

## 2. 